// keys duplicated from credentials for convenience
var key1 = "BULeR8JyUWhiuuCMU/HLA0Q5pzkYT+cHII3ZKBey3Bo=";
var key2 = "QfeDAys9MPDs2XHExtc84jKGHxZg/aj52DTh0vtA3Xc=";
var key3 = "1iTZde/ndBHvzhcl7V68x44Vx7pl8nwx9LqnM/AfJUg=";

var contract = eth.contract([{"constant":false,"inputs":[],"name":"readMessage","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"message","type":"string"}],"name":"sendMessage","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":false,"name":"message","type":"string"}],"name":"Message","type":"event"}]);

var data = '6060604052341561000c57fe5b5b604060405190810160405280600c81526020017f696e626f7820656d70747921000000000000000000000000000000000000000081525060009080519060200190610059929190610060565b505b610105565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100a157805160ff19168380011785556100cf565b828001600101855582156100cf579182015b828111156100ce5782518255916020019190600101906100b3565b5b5090506100dc91906100e0565b5090565b61010291905b808211156100fe5760008160009055506001016100e6565b5090565b90565b6103a3806101146000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063031d5d0114610046578063469c8110146100df575bfe5b341561004e57fe5b610056610139565b60405180806020018281038252838181518152602001915080519060200190808383600083146100a5575b8051825260208311156100a557602082019150602081019050602083039250610081565b505050905090810190601f1680156100d15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156100e757fe5b610137600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506101e2565b005b6101416102be565b60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156101d75780601f106101ac576101008083540402835291602001916101d7565b820191906000526020600020905b8154815290600101906020018083116101ba57829003601f168201915b505050505090505b90565b80600090805190602001906101f89291906102d2565b503373ffffffffffffffffffffffffffffffffffffffff167f811f7cff0a3374ff67cccc3726035d34ba70410e0256818a891e4d6acc01d88e826040518080602001828103825283818151815260200191508051906020019080838360008314610281575b8051825260208311156102815760208201915060208101905060208303925061025d565b505050905090810190601f1680156102ad5780820380516001836020036101000a031916815260200191505b509250505060405180910390a25b50565b602060405190810160405280600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061031357805160ff1916838001178555610341565b82800160010185558215610341579182015b82811115610340578251825591602001919060010190610325565b5b50905061034e9190610352565b5090565b61037491905b80821115610370576000816000905550600101610358565b5090565b905600a165627a7a7230582050b8476893c95f00db920f426a032379b2b8a071442fc3503515fc157b976de20029';

var from = eth.accounts[0];
var gas = '4700000';

function createInbox(privateFor) {
  var messageBox = contract.new({
    from: from,
    data: data,
    gas: gas,
    privateFor: privateFor
  }, function (e, contract) {
    if (typeof contract.address !== 'undefined') {
      console.log('Contract mined!');
      console.log('address: ' + contract.address);
      console.log('transactionHash: ' + contract.transactionHash);
      console.log('tell your friend to run listen("' + contract.address + '")');
    }
  });

  return function send(msg) {
    messageBox.sendMessage(msg, {
      from: from,
      privateFor: privateFor,
      gas: gas,
    });
  }
}

function listen(address) {
  contract.at(address).Message(function(error, result) {
    if (error) {
      console.log(error);
    } else {
      // console.log(result.args.from);
      console.log(result.args.message);
    }
  });
}
